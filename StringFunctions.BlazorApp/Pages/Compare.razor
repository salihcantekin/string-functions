@page "/compare"

<SeoHead Route="compare" />

<PageTitle>String Compare</PageTitle>

<ToolPageLayout Title="String Compare" Description="Compare two strings and see the differences.">
    <OptionsContent>
        <FluentCheckbox @bind-Value="@ignoreCase" Label="Ignore case" @bind-Value:after="ProcessComparison" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@ignoreWhitespace" Label="Ignore whitespace" @bind-Value:after="ProcessComparison" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@trimLines" Label="Trim lines" @bind-Value:after="ProcessComparison" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@showLineByLine" Label="Line-by-line comparison" @bind-Value:after="ProcessComparison" />
    </OptionsContent>
    <ChildContent>
        <div class="compare-grid">
            <div class="io-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">String 1</span>
                    <span class="io-panel-stats">@text1.Length chars | @text1.Split('\n').Length lines</span>
                </div>
                <FluentTextArea @bind-Value="@text1" 
                               Placeholder="Enter first string..."
                               Resize="TextAreaResize.Vertical"
                               @oninput="OnTextChanged" />
            </div>

            <div class="io-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">String 2</span>
                    <span class="io-panel-stats">@text2.Length chars | @text2.Split('\n').Length lines</span>
                </div>
                <FluentTextArea @bind-Value="@text2" 
                               Placeholder="Enter second string..."
                               Resize="TextAreaResize.Vertical"
                               @oninput="OnTextChanged" />
            </div>
        </div>

        <div class="result-section">
            @if (areEqual)
            {
                <FluentMessageBar Title="Match" Intent="MessageIntent.Success">
                    The two strings are identical.
                </FluentMessageBar>
            }
            else if (!string.IsNullOrEmpty(text1) || !string.IsNullOrEmpty(text2))
            {
                <FluentMessageBar Title="Different" Intent="MessageIntent.Warning">
                    The strings are different.
                </FluentMessageBar>
                
                @if (showLineByLine && lineDifferences.Any())
                {
                    <div class="diff-view">
                        <h4>Line-by-line Comparison:</h4>
                        <div class="diff-content">
                            @foreach (var diff in lineDifferences)
                            {
                                <div class="diff-line @(diff.IsDifferent ? "different" : "")">
                                    <span class="diff-line-num">@diff.LineNumber</span>
                                    @if (diff.IsDifferent)
                                    {
                                        <div class="diff-changes">
                                            <div class="diff-removed">- @diff.Line1</div>
                                            <div class="diff-added">+ @diff.Line2</div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="diff-same">@diff.Line1</span>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
                
                <p class="stats-text">@statistics</p>
            }
        </div>
    </ChildContent>
</ToolPageLayout>

<style>
    .compare-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        flex: 1;
    }

    .io-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .io-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 32px;
    }

    .io-panel-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .io-panel-stats {
        font-size: 0.8rem;
        color: var(--text-tertiary);
    }

    .result-section {
        margin-top: 16px;
    }

    .diff-view {
        margin-top: 16px;
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 16px;
    }

    .diff-view h4 {
        margin: 0 0 12px 0;
        color: var(--text-primary);
    }

    .diff-content {
        font-family: monospace;
        font-size: 0.85rem;
        max-height: 300px;
        overflow-y: auto;
    }

    .diff-line {
        display: flex;
        gap: 12px;
        padding: 4px 8px;
        border-radius: 4px;
    }

    .diff-line.different {
        background: var(--warning-bg);
    }

    .diff-line-num {
        color: var(--text-tertiary);
        min-width: 30px;
    }

    .diff-changes {
        flex: 1;
    }

    .diff-removed {
        color: var(--error);
    }

    .diff-added {
        color: var(--success);
    }

    .diff-same {
        color: var(--text-primary);
    }

    .stats-text {
        margin-top: 12px;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }

    @@media (max-width: 768px) {
        .compare-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .diff-content {
            max-height: 200px;
        }
    }
</style>

@code {
    private string text1 = string.Empty;
    private string text2 = string.Empty;
    private bool ignoreCase = false;
    private bool ignoreWhitespace = false;
    private bool trimLines = false;
    private bool showLineByLine = true;
    private bool areEqual = false;
    private string statistics = string.Empty;
    private List<LineDifference> lineDifferences = new();

    private void OnTextChanged(ChangeEventArgs e)
    {
        ProcessComparison();
    }

    private void ProcessComparison()
    {
        var processedText1 = ProcessText(text1);
        var processedText2 = ProcessText(text2);

        var comparison = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
        areEqual = string.Equals(processedText1, processedText2, comparison);

        if (!areEqual && showLineByLine)
        {
            CompareLineByLine();
        }

        CalculateStatistics();
    }

    private string ProcessText(string text)
    {
        if (string.IsNullOrEmpty(text)) return text;

        if (ignoreWhitespace)
        {
            text = new string(text.Where(c => !char.IsWhiteSpace(c)).ToArray());
        }

        if (trimLines)
        {
            var lines = text.Split('\n').Select(l => l.Trim());
            text = string.Join("\n", lines);
        }

        return text;
    }

    private void CompareLineByLine()
    {
        lineDifferences.Clear();
        var lines1 = text1.Split('\n');
        var lines2 = text2.Split('\n');
        var maxLines = Math.Max(lines1.Length, lines2.Length);

        for (int i = 0; i < maxLines; i++)
        {
            var line1 = i < lines1.Length ? lines1[i] : string.Empty;
            var line2 = i < lines2.Length ? lines2[i] : string.Empty;

            var processedLine1 = ProcessText(line1);
            var processedLine2 = ProcessText(line2);

            var comparison = ignoreCase ? StringComparison.OrdinalIgnoreCase : StringComparison.Ordinal;
            var isDifferent = !string.Equals(processedLine1, processedLine2, comparison);

            lineDifferences.Add(new LineDifference
            {
                LineNumber = i + 1,
                Line1 = line1,
                Line2 = line2,
                IsDifferent = isDifferent
            });
        }
    }

    private void CalculateStatistics()
    {
        var lengthDiff = Math.Abs(text1.Length - text2.Length);
        var lineDiff = Math.Abs(text1.Split('\n').Length - text2.Split('\n').Length);
        var differentLines = lineDifferences.Count(d => d.IsDifferent);

        statistics = $"Character difference: {lengthDiff} | Line count difference: {lineDiff} | Different lines: {differentLines}";
    }

    private class LineDifference
    {
        public int LineNumber { get; set; }
        public string Line1 { get; set; } = string.Empty;
        public string Line2 { get; set; } = string.Empty;
        public bool IsDifferent { get; set; }
    }
}
