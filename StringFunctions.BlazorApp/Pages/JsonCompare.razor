@page "/json-compare"

<SeoHead Route="json-compare" />
@using System.Text.Json

<PageTitle>JSON Compare</PageTitle>

<ToolPageLayout Title="JSON Compare" Description="Compare two JSON documents and see the differences.">
    <OptionsContent>
        <FluentCheckbox @bind-Value="@ignoreOrder" Label="Ignore array order" @bind-Value:after="CompareJson" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@ignoreWhitespace" Label="Ignore whitespace" @bind-Value:after="CompareJson" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@strictTypes" Label="Strict types" @bind-Value:after="CompareJson" />
    </OptionsContent>
    <ChildContent>
        <div class="compare-grid">
            <JsonInputArea Title="JSON 1"
                          @bind-Value="@json1"
                          Placeholder='{"name": "John", "age": 30}'
                          ShowFormatButton="true"
                          ShowCopyButton="false"
                          AutoFormat="true"
                          OnError="e => error1 = e" />

            <JsonInputArea Title="JSON 2"
                          @bind-Value="@json2"
                          Placeholder='{"name": "Jane", "age": 25}'
                          ShowFormatButton="true"
                          ShowCopyButton="false"
                          AutoFormat="true"
                          OnError="e => error2 = e" />
        </div>

        <div class="result-section">
            @if (isValid && areEqual)
            {
                <FluentMessageBar Title="Match" Intent="MessageIntent.Success">
                    The two JSON documents are identical.
                </FluentMessageBar>
            }
            else if (isValid && !areEqual)
            {
                <FluentMessageBar Title="Different" Intent="MessageIntent.Warning">
                    Found @differences.Count difference(s).
                </FluentMessageBar>
                
                @if (differences.Any())
                {
                    <div class="diff-list">
                        @foreach (var diff in differences)
                        {
                            <div class="diff-item">
                                <span class="diff-path">@diff.Path</span>
                                <div class="diff-values">
                                    <span class="diff-old">- @diff.Value1</span>
                                    <span class="diff-new">+ @diff.Value2</span>
                                </div>
                            </div>
                        }
                    </div>
                }
            }
        </div>
    </ChildContent>
</ToolPageLayout>

@code {
    private string json1 = string.Empty;
    private string json2 = string.Empty;
    private string? error1;
    private string? error2;
    private bool ignoreOrder = false;
    private bool ignoreWhitespace = true;
    private bool strictTypes = true;
    private bool isValid = false;
    private bool areEqual = false;
    private List<JsonDifference> differences = new();

    private void CompareJson()
    {
        error1 = null;
        error2 = null;
        isValid = false;
        areEqual = false;
        differences.Clear();

        if (string.IsNullOrWhiteSpace(json1) || string.IsNullOrWhiteSpace(json2))
            return;

        try
        {
            using var doc1 = JsonDocument.Parse(json1);
            using var doc2 = JsonDocument.Parse(json2);
            
            isValid = true;
            CompareElements(doc1.RootElement, doc2.RootElement, "$");
            areEqual = !differences.Any();
        }
        catch (JsonException ex) when (json1.Contains(ex.Message) || differences.Count == 0)
        {
            error1 = $"JSON error: {ex.Message}";
        }
        catch (JsonException ex)
        {
            error2 = $"JSON error: {ex.Message}";
        }
        catch (Exception ex)
        {
            error1 = ex.Message;
        }
    }

    private void CompareElements(JsonElement elem1, JsonElement elem2, string path)
    {
        if (elem1.ValueKind != elem2.ValueKind)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = $"Type: {elem1.ValueKind}",
                Value2 = $"Type: {elem2.ValueKind}"
            });
            return;
        }

        switch (elem1.ValueKind)
        {
            case JsonValueKind.Object:
                CompareObjects(elem1, elem2, path);
                break;
            case JsonValueKind.Array:
                CompareArrays(elem1, elem2, path);
                break;
            case JsonValueKind.String:
            case JsonValueKind.Number:
            case JsonValueKind.True:
            case JsonValueKind.False:
            case JsonValueKind.Null:
                CompareValues(elem1, elem2, path);
                break;
        }
    }

    private void CompareObjects(JsonElement obj1, JsonElement obj2, string path)
    {
        var props1 = obj1.EnumerateObject().ToDictionary(p => p.Name, p => p.Value);
        var props2 = obj2.EnumerateObject().ToDictionary(p => p.Name, p => p.Value);

        foreach (var key in props1.Keys.Union(props2.Keys))
        {
            if (!props1.ContainsKey(key))
            {
                differences.Add(new JsonDifference
                {
                    Path = $"{path}.{key}",
                    Value1 = "(missing)",
                    Value2 = props2[key].ToString()
                });
            }
            else if (!props2.ContainsKey(key))
            {
                differences.Add(new JsonDifference
                {
                    Path = $"{path}.{key}",
                    Value1 = props1[key].ToString(),
                    Value2 = "(missing)"
                });
            }
            else
            {
                CompareElements(props1[key], props2[key], $"{path}.{key}");
            }
        }
    }

    private void CompareArrays(JsonElement arr1, JsonElement arr2, string path)
    {
        var list1 = arr1.EnumerateArray().ToList();
        var list2 = arr2.EnumerateArray().ToList();

        if (list1.Count != list2.Count)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = $"Array length: {list1.Count}",
                Value2 = $"Array length: {list2.Count}"
            });
        }

        if (!ignoreOrder)
        {
            for (int i = 0; i < Math.Min(list1.Count, list2.Count); i++)
            {
                CompareElements(list1[i], list2[i], $"{path}[{i}]");
            }
        }
    }

    private void CompareValues(JsonElement val1, JsonElement val2, string path)
    {
        var str1 = val1.ToString();
        var str2 = val2.ToString();

        if (ignoreWhitespace)
        {
            str1 = str1.Trim();
            str2 = str2.Trim();
        }

        if (str1 != str2)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = str1,
                Value2 = str2
            });
        }
    }

    private class JsonDifference
    {
        public string Path { get; set; } = string.Empty;
        public string Value1 { get; set; } = string.Empty;
        public string Value2 { get; set; } = string.Empty;
    }
}
