@page "/json-compare"
@using System.Text.Json

<PageTitle>JSON Compare</PageTitle>

<FluentStack Orientation="Orientation.Vertical" Style="gap: 20px;">
    <FluentCard Style="padding: 20px;">
        <FluentLabel Typo="Typography.H3">JSON Compare</FluentLabel>
        <FluentLabel Typo="Typography.Body">İki JSON'ı karşılaştırın ve farklılıkları görün.</FluentLabel>
    </FluentCard>

    <FluentCard Style="padding: 20px;">
        <FluentStack Orientation="Orientation.Vertical" Style="gap: 16px;">
            <FluentLabel Typo="Typography.H5">Ayarlar</FluentLabel>
            
            <FluentCheckbox @bind-Value="@ignoreOrder" Label="Array elemanlarının sırasını yoksay" />
            
            <FluentCheckbox @bind-Value="@ignoreWhitespace" Label="Whitespace farklılıklarını yoksay" />
            
            <FluentCheckbox @bind-Value="@strictTypes" Label="Katı tip kontrolü (3 ve "3" farklıdır)" />
        </FluentStack>
    </FluentCard>

    <FluentGrid Spacing="3">
        <FluentGridItem xs="12" md="6">
            <FluentCard Style="padding: 20px;">
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 12px;">
                    <FluentLabel Typo="Typography.H5">JSON 1</FluentLabel>
                    <FluentTextArea @bind-Value="@json1" 
                                   Placeholder='{"name": "John", "age": 30}'
                                   Rows="15"
                                   Style="width: 100%; font-family: monospace;"
                                   @oninput="OnJsonChanged" />
                    @if (!string.IsNullOrEmpty(error1))
                    {
                        <FluentLabel Style="color: var(--error);">@error1</FluentLabel>
                    }
                </FluentStack>
            </FluentCard>
        </FluentGridItem>

        <FluentGridItem xs="12" md="6">
            <FluentCard Style="padding: 20px;">
                <FluentStack Orientation="Orientation.Vertical" Style="gap: 12px;">
                    <FluentLabel Typo="Typography.H5">JSON 2</FluentLabel>
                    <FluentTextArea @bind-Value="@json2" 
                                   Placeholder='{"name": "Jane", "age": 25}'
                                   Rows="15"
                                   Style="width: 100%; font-family: monospace;"
                                   @oninput="OnJsonChanged" />
                    @if (!string.IsNullOrEmpty(error2))
                    {
                        <FluentLabel Style="color: var(--error);">@error2</FluentLabel>
                    }
                </FluentStack>
            </FluentCard>
        </FluentGridItem>
    </FluentGrid>

    <FluentCard Style="padding: 20px;">
        <FluentStack Orientation="Orientation.Vertical" Style="gap: 12px;">
            <FluentLabel Typo="Typography.H5">Karşılaştırma Sonucu</FluentLabel>
            
            @if (isValid && areEqual)
            {
                <FluentMessageBar Title="Eşit" Intent="MessageIntent.Success">
                    İki JSON birbiriyle eşleşiyor.
                </FluentMessageBar>
            }
            else if (isValid && !areEqual)
            {
                <FluentMessageBar Title="Farklı" Intent="MessageIntent.Warning">
                    JSON'lar farklı. Aşağıda farklılıkları görebilirsiniz.
                </FluentMessageBar>
                
                @if (differences.Any())
                {
                    <FluentLabel Typo="Typography.Body" Style="font-weight: 600; margin-top: 12px;">Farklılıklar:</FluentLabel>
                    <div style="background: var(--neutral-layer-1); padding: 12px; border-radius: 4px; font-family: monospace; max-height: 400px; overflow-y: auto;">
                        @foreach (var diff in differences)
                        {
                            <div style="padding: 8px; margin: 4px 0; background: var(--fill-color-warning); border-radius: 4px;">
                                <div style="font-weight: 600; color: var(--accent-fill-rest);">@diff.Path</div>
                                <div style="margin-top: 4px;">
                                    <span style="color: #ff6b6b;">- JSON 1: @diff.Value1</span>
                                </div>
                                <div>
                                    <span style="color: #51cf66;">+ JSON 2: @diff.Value2</span>
                                </div>
                            </div>
                        }
                    </div>
                    <FluentLabel Typo="Typography.Body">Toplam @differences.Count farklılık bulundu.</FluentLabel>
                }
            }
        </FluentStack>
    </FluentCard>
</FluentStack>

@code {
    private string json1 = string.Empty;
    private string json2 = string.Empty;
    private string error1 = string.Empty;
    private string error2 = string.Empty;
    private bool ignoreOrder = false;
    private bool ignoreWhitespace = true;
    private bool strictTypes = true;
    private bool isValid = false;
    private bool areEqual = false;
    private List<JsonDifference> differences = new();

    private void OnJsonChanged(ChangeEventArgs e)
    {
        CompareJson();
    }


    private void CompareJson()
    {
        error1 = string.Empty;
        error2 = string.Empty;
        isValid = false;
        areEqual = false;
        differences.Clear();

        if (string.IsNullOrWhiteSpace(json1) || string.IsNullOrWhiteSpace(json2))
            return;

        try
        {
            using var doc1 = JsonDocument.Parse(json1);
            using var doc2 = JsonDocument.Parse(json2);
            
            isValid = true;
            CompareElements(doc1.RootElement, doc2.RootElement, "$");
            areEqual = !differences.Any();
        }
        catch (JsonException ex) when (ex.Message.Contains("json1"))
        {
            error1 = $"JSON hatası: {ex.Message}";
        }
        catch (JsonException ex)
        {
            error2 = $"JSON hatası: {ex.Message}";
        }
        catch (Exception ex)
        {
            error1 = ex.Message;
        }
    }

    private void CompareElements(JsonElement elem1, JsonElement elem2, string path)
    {
        if (elem1.ValueKind != elem2.ValueKind)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = $"Type: {elem1.ValueKind}",
                Value2 = $"Type: {elem2.ValueKind}"
            });
            return;
        }

        switch (elem1.ValueKind)
        {
            case JsonValueKind.Object:
                CompareObjects(elem1, elem2, path);
                break;
            case JsonValueKind.Array:
                CompareArrays(elem1, elem2, path);
                break;
            case JsonValueKind.String:
            case JsonValueKind.Number:
            case JsonValueKind.True:
            case JsonValueKind.False:
            case JsonValueKind.Null:
                CompareValues(elem1, elem2, path);
                break;
        }
    }

    private void CompareObjects(JsonElement obj1, JsonElement obj2, string path)
    {
        var props1 = obj1.EnumerateObject().ToDictionary(p => p.Name, p => p.Value);
        var props2 = obj2.EnumerateObject().ToDictionary(p => p.Name, p => p.Value);

        foreach (var key in props1.Keys.Union(props2.Keys))
        {
            if (!props1.ContainsKey(key))
            {
                differences.Add(new JsonDifference
                {
                    Path = $"{path}.{key}",
                    Value1 = "(missing)",
                    Value2 = props2[key].ToString()
                });
            }
            else if (!props2.ContainsKey(key))
            {
                differences.Add(new JsonDifference
                {
                    Path = $"{path}.{key}",
                    Value1 = props1[key].ToString(),
                    Value2 = "(missing)"
                });
            }
            else
            {
                CompareElements(props1[key], props2[key], $"{path}.{key}");
            }
        }
    }

    private void CompareArrays(JsonElement arr1, JsonElement arr2, string path)
    {
        var list1 = arr1.EnumerateArray().ToList();
        var list2 = arr2.EnumerateArray().ToList();

        if (list1.Count != list2.Count)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = $"Array length: {list1.Count}",
                Value2 = $"Array length: {list2.Count}"
            });
        }

        if (!ignoreOrder)
        {
            for (int i = 0; i < Math.Min(list1.Count, list2.Count); i++)
            {
                CompareElements(list1[i], list2[i], $"{path}[{i}]");
            }
        }
    }

    private void CompareValues(JsonElement val1, JsonElement val2, string path)
    {
        var str1 = val1.ToString();
        var str2 = val2.ToString();

        if (ignoreWhitespace)
        {
            str1 = str1.Trim();
            str2 = str2.Trim();
        }

        if (str1 != str2)
        {
            differences.Add(new JsonDifference
            {
                Path = path,
                Value1 = str1,
                Value2 = str2
            });
        }
    }

    private class JsonDifference
    {
        public string Path { get; set; } = string.Empty;
        public string Value1 { get; set; } = string.Empty;
        public string Value2 { get; set; } = string.Empty;
    }
}
