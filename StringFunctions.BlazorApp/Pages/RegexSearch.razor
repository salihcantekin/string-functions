@page "/regex-search"

<SeoHead Route="regex-search" />
@using System.Text.RegularExpressions

<PageTitle>Regex Search</PageTitle>

<ToolPageLayout Title="Regex Search" Description="Search text using regular expressions and find matches.">
    <OptionsContent>
        <div class="option-group">
            <span class="option-label">Pattern:</span>
            <FluentTextField @bind-Value="@pattern" Placeholder="\d+" Style="min-width: 200px;" @bind-Value:after="ProcessSearch" />
        </div>
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@ignoreCase" Label="Ignore case" @bind-Value:after="ProcessSearch" />
        <FluentCheckbox @bind-Value="@multiline" Label="Multiline" @bind-Value:after="ProcessSearch" />
        <FluentCheckbox @bind-Value="@singleline" Label="Singleline" @bind-Value:after="ProcessSearch" />
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@showOnlyMatches" Label="Show matches only" @bind-Value:after="ProcessSearch" />
    </OptionsContent>
    <ChildContent>
        @if (!string.IsNullOrEmpty(regexError))
        {
            <FluentMessageBar Title="Regex Error" Intent="MessageIntent.Error" Style="margin-bottom: 8px;">
                @regexError
            </FluentMessageBar>
        }

        <div class="search-layout">
            <div class="io-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">Input</span>
                </div>
                <FluentTextArea @bind-Value="@inputText" 
                               Placeholder="Enter text to search..."
                               Resize="TextAreaResize.Vertical"
                               @oninput="OnInputChanged" />
            </div>

            <div class="results-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">Results (@matches.Count matches)</span>
                    <CopyButton Text="@outputText" />
                </div>
                
                @if (showOnlyMatches)
                {
                    <FluentTextArea Value="@outputText" 
                                   ReadOnly="true"
                                   Resize="TextAreaResize.Vertical" />
                }
                else if (matches.Any())
                {
                    <div class="matches-list">
                        @foreach (var (match, index) in matches.Take(50).Select((m, i) => (m, i)))
                        {
                            <div class="match-item">
                                <span class="match-index">#@(index + 1)</span>
                                <span class="match-info">Index: @match.Index, Length: @match.Length</span>
                                <code class="match-value">"@match.Value"</code>
                                @if (match.Groups.Count > 1)
                                {
                                    <div class="match-groups">
                                        @for (int i = 1; i < match.Groups.Count; i++)
                                        {
                                            <span class="group-item">Group @i: "@match.Groups[i].Value"</span>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        @if (matches.Count > 50)
                        {
                            <p class="more-matches">... and @(matches.Count - 50) more matches</p>
                        }
                    </div>
                }
                else
                {
                    <div class="no-matches">No matches found</div>
                }
            </div>
        </div>
    </ChildContent>
</ToolPageLayout>

<style>
    .search-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .io-panel, .results-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .io-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 32px;
    }

    .io-panel-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    .matches-list {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 12px;
        flex: 1;
        overflow-y: auto;
        max-height: 400px;
    }

    .match-item {
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.85rem;
    }

    .match-item:last-child {
        border-bottom: none;
    }

    .match-index {
        font-weight: 600;
        color: var(--accent-primary);
        margin-right: 8px;
    }

    .match-info {
        color: var(--text-secondary);
        margin-right: 12px;
    }

    .match-value {
        background: var(--accent-light);
        padding: 2px 6px;
        border-radius: 4px;
        color: var(--accent-primary);
    }

    .match-groups {
        margin-top: 4px;
        margin-left: 20px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .group-item {
        display: block;
    }

    .no-matches {
        padding: 24px;
        text-align: center;
        color: var(--text-tertiary);
        background: var(--bg-secondary);
        border-radius: 6px;
    }

    .more-matches {
        text-align: center;
        color: var(--text-secondary);
        font-style: italic;
        margin-top: 8px;
    }

    @@media (max-width: 768px) {
        .search-layout {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private string inputText = string.Empty;
    private string outputText = string.Empty;
    private string pattern = @"\d+";
    private string regexError = string.Empty;
    private bool ignoreCase = false;
    private bool multiline = false;
    private bool singleline = false;
    private bool showOnlyMatches = false;
    private List<Match> matches = new();

    private void OnInputChanged(ChangeEventArgs e)
    {
        inputText = e.Value?.ToString() ?? string.Empty;
        ProcessSearch();
    }

    private void ProcessSearch()
    {
        regexError = string.Empty;
        matches.Clear();
        
        if (string.IsNullOrEmpty(inputText) || string.IsNullOrEmpty(pattern))
        {
            outputText = string.Empty;
            return;
        }

        try
        {
            var options = RegexOptions.None;
            if (ignoreCase) options |= RegexOptions.IgnoreCase;
            if (multiline) options |= RegexOptions.Multiline;
            if (singleline) options |= RegexOptions.Singleline;

            var regex = new Regex(pattern, options);
            matches = regex.Matches(inputText).ToList();

            outputText = string.Join("\n", matches.Select(m => m.Value));
        }
        catch (Exception ex)
        {
            regexError = ex.Message;
            outputText = string.Empty;
        }
    }
}
