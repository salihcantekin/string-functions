@page "/password-generator"
@using System.Security.Cryptography

<PageTitle>Password Generator</PageTitle>

<ToolPageLayout Title="Password Generator" Description="Generate secure passwords with customizable rules and requirements.">
    <OptionsContent>
        <div class="option-group">
            <span class="option-label">Length:</span>
            <FluentNumberField @bind-Value="@passwordLength" Min="4" Max="128" Style="width: 80px;" />
        </div>
        <div class="option-divider"></div>
        <div class="option-group">
            <span class="option-label">Count:</span>
            <FluentNumberField @bind-Value="@passwordCount" Min="1" Max="50" Style="width: 70px;" />
        </div>
        <div class="option-divider"></div>
        <FluentButton Appearance="Appearance.Accent" OnClick="GeneratePasswords">Generate</FluentButton>
    </OptionsContent>
    <ChildContent>
        <div class="password-layout">
            <!-- Character Options -->
            <div class="options-section">
                <h3>Character Types</h3>
                <div class="char-options-grid">
                    <div class="char-option">
                        <FluentCheckbox @bind-Value="@includeLowercase" Label="Lowercase (a-z)" />
                        <span class="char-preview">abcdefghijklmnopqrstuvwxyz</span>
                    </div>
                    <div class="char-option">
                        <FluentCheckbox @bind-Value="@includeUppercase" Label="Uppercase (A-Z)" />
                        <span class="char-preview">ABCDEFGHIJKLMNOPQRSTUVWXYZ</span>
                    </div>
                    <div class="char-option">
                        <FluentCheckbox @bind-Value="@includeNumbers" Label="Numbers (0-9)" />
                        <span class="char-preview">0123456789</span>
                    </div>
                    <div class="char-option">
                        <FluentCheckbox @bind-Value="@includeSymbols" Label="Symbols" />
                        <span class="char-preview">@defaultSymbols</span>
                    </div>
                    <div class="char-option custom-symbols">
                        <FluentCheckbox @bind-Value="@useCustomSymbols" Label="Custom symbols" />
                        <FluentTextField @bind-Value="@customSymbols" 
                                        Placeholder="!#$%^&*()" 
                                        Style="width: 200px;" 
                                        Disabled="@(!useCustomSymbols)" />
                    </div>
                </div>
            </div>

            <!-- Advanced Rules -->
            <div class="options-section">
                <h3>Advanced Rules</h3>
                <div class="rules-grid">
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@excludeAmbiguous" Label="Exclude ambiguous characters" />
                        <span class="rule-hint">l, 1, I, O, 0, o</span>
                    </div>
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@excludeSimilar" Label="Exclude similar characters" />
                        <span class="rule-hint">i, l, 1, L, o, 0, O</span>
                    </div>
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@noRepeating" Label="No repeating characters" />
                    </div>
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@noSequential" Label="No sequential characters" />
                        <span class="rule-hint">abc, 123, etc.</span>
                    </div>
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@beginWithLetter" Label="Begin with a letter" />
                    </div>
                    <div class="rule-item">
                        <FluentCheckbox @bind-Value="@requireAll" Label="Require all selected types" />
                        <span class="rule-hint">At least one of each</span>
                    </div>
                </div>
            </div>

            <!-- Minimum Requirements -->
            <div class="options-section">
                <h3>Minimum Requirements</h3>
                <div class="min-requirements-grid">
                    <div class="min-req-item">
                        <span class="min-req-label">Min lowercase:</span>
                        <FluentNumberField @bind-Value="@minLowercase" Min="0" Max="@passwordLength.ToString()" Style="width: 70px;" Disabled="@(!includeLowercase)" />
                    </div>
                    <div class="min-req-item">
                        <span class="min-req-label">Min uppercase:</span>
                        <FluentNumberField @bind-Value="@minUppercase" Min="0" Max="@passwordLength.ToString()" Style="width: 70px;" Disabled="@(!includeUppercase)" />
                    </div>
                    <div class="min-req-item">
                        <span class="min-req-label">Min numbers:</span>
                        <FluentNumberField @bind-Value="@minNumbers" Min="0" Max="@passwordLength.ToString()" Style="width: 70px;" Disabled="@(!includeNumbers)" />
                    </div>
                    <div class="min-req-item">
                        <span class="min-req-label">Min symbols:</span>
                        <FluentNumberField @bind-Value="@minSymbols" Min="0" Max="@passwordLength.ToString()" Style="width: 70px;" Disabled="@(!includeSymbols && !useCustomSymbols)" />
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <FluentMessageBar Title="Error" Intent="MessageIntent.Error">
                    @errorMessage
                </FluentMessageBar>
            }

            <!-- Generated Passwords -->
            <div class="passwords-section">
                <div class="passwords-header">
                    <h3>Generated Passwords (@passwords.Count)</h3>
                    <CopyButton Text="@string.Join(Environment.NewLine, passwords)" />
                </div>
                <div class="passwords-list">
                    @foreach (var password in passwords)
                    {
                        <div class="password-item">
                            <code class="password-text">@password</code>
                            <div class="password-actions">
                                <span class="password-strength @GetStrengthClass(password)">@GetStrengthLabel(password)</span>
                                <CopyButton Text="@password" />
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Strength Indicator Legend -->
            <div class="strength-legend">
                <h4>Password Strength</h4>
                <div class="legend-items">
                    <span class="legend-item"><span class="strength-dot very-weak"></span> Very Weak</span>
                    <span class="legend-item"><span class="strength-dot weak"></span> Weak</span>
                    <span class="legend-item"><span class="strength-dot fair"></span> Fair</span>
                    <span class="legend-item"><span class="strength-dot strong"></span> Strong</span>
                    <span class="legend-item"><span class="strength-dot very-strong"></span> Very Strong</span>
                </div>
            </div>
        </div>
    </ChildContent>
</ToolPageLayout>

<style>
    .password-layout {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .options-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
    }

    .options-section h3 {
        margin: 0 0 12px 0;
        font-size: 0.95rem;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-color);
        padding-bottom: 8px;
    }

    .char-options-grid {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .char-option {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .char-option.custom-symbols {
        flex-wrap: wrap;
    }

    .char-preview {
        font-family: monospace;
        font-size: 0.8rem;
        color: var(--text-tertiary);
        background: var(--bg-tertiary);
        padding: 2px 8px;
        border-radius: 4px;
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .rules-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
    }

    .rule-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .rule-hint {
        font-size: 0.75rem;
        color: var(--text-tertiary);
    }

    .min-requirements-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
    }

    .min-req-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .min-req-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        min-width: 100px;
    }

    .passwords-section {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 16px;
    }

    .passwords-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }

    .passwords-header h3 {
        margin: 0;
        font-size: 0.95rem;
        color: var(--text-primary);
    }

    .passwords-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 400px;
        overflow-y: auto;
    }

    .password-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 12px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        gap: 12px;
    }

    .password-text {
        font-family: 'Consolas', monospace;
        font-size: 1rem;
        color: var(--accent-primary);
        word-break: break-all;
        flex: 1;
    }

    .password-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
    }

    .password-strength {
        font-size: 0.75rem;
        padding: 2px 8px;
        border-radius: 4px;
        font-weight: 500;
    }

    .password-strength.very-weak { background: #ff4444; color: white; }
    .password-strength.weak { background: #ff8800; color: white; }
    .password-strength.fair { background: #ffcc00; color: #333; }
    .password-strength.strong { background: #44bb44; color: white; }
    .password-strength.very-strong { background: #00aa00; color: white; }

    .strength-legend {
        background: var(--bg-secondary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 12px 16px;
    }

    .strength-legend h4 {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        color: var(--text-secondary);
    }

    .legend-items {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .strength-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .strength-dot.very-weak { background: #ff4444; }
    .strength-dot.weak { background: #ff8800; }
    .strength-dot.fair { background: #ffcc00; }
    .strength-dot.strong { background: #44bb44; }
    .strength-dot.very-strong { background: #00aa00; }

    @@media (max-width: 768px) {
        .rules-grid,
        .min-requirements-grid {
            grid-template-columns: 1fr;
        }

        .password-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .password-actions {
            width: 100%;
            justify-content: space-between;
        }

        .legend-items {
            gap: 8px;
        }
    }
</style>

@code {
    private int passwordLength = 16;
    private int passwordCount = 5;
    
    // Character types
    private bool includeLowercase = true;
    private bool includeUppercase = true;
    private bool includeNumbers = true;
    private bool includeSymbols = true;
    private bool useCustomSymbols = false;
    private string customSymbols = "!@#$%^&*";
    private const string defaultSymbols = "!@#$%^&*()_+-=[]{}|;:',.<>?/~`";
    
    // Advanced rules
    private bool excludeAmbiguous = false;
    private bool excludeSimilar = false;
    private bool noRepeating = false;
    private bool noSequential = false;
    private bool beginWithLetter = false;
    private bool requireAll = true;
    
    // Minimum requirements
    private int minLowercase = 1;
    private int minUppercase = 1;
    private int minNumbers = 1;
    private int minSymbols = 1;
    
    private List<string> passwords = new();
    private string errorMessage = string.Empty;
    
    private const string LowercaseChars = "abcdefghijklmnopqrstuvwxyz";
    private const string UppercaseChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private const string NumberChars = "0123456789";
    private const string AmbiguousChars = "l1IO0o";
    private const string SimilarChars = "il1Lo0O";

    protected override void OnInitialized()
    {
        GeneratePasswords();
    }

    private void GeneratePasswords()
    {
        errorMessage = string.Empty;
        passwords.Clear();

        // Validate settings
        if (!includeLowercase && !includeUppercase && !includeNumbers && !includeSymbols && !useCustomSymbols)
        {
            errorMessage = "Please select at least one character type.";
            return;
        }

        var minTotal = (includeLowercase ? minLowercase : 0) + 
                       (includeUppercase ? minUppercase : 0) + 
                       (includeNumbers ? minNumbers : 0) + 
                       ((includeSymbols || useCustomSymbols) ? minSymbols : 0);

        if (minTotal > passwordLength)
        {
            errorMessage = "Minimum requirements exceed password length.";
            return;
        }

        try
        {
            for (int i = 0; i < passwordCount; i++)
            {
                var password = GenerateSinglePassword();
                if (password != null)
                {
                    passwords.Add(password);
                }
                else
                {
                    errorMessage = "Could not generate password with current rules. Try relaxing some constraints.";
                    break;
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
    }

    private string? GenerateSinglePassword()
    {
        var charPool = BuildCharacterPool();
        if (string.IsNullOrEmpty(charPool))
            return null;

        var maxAttempts = 1000;
        for (int attempt = 0; attempt < maxAttempts; attempt++)
        {
            var password = GeneratePasswordCandidate(charPool);
            if (ValidatePassword(password))
                return password;
        }

        return null;
    }

    private string BuildCharacterPool()
    {
        var pool = new System.Text.StringBuilder();

        if (includeLowercase)
            pool.Append(FilterChars(LowercaseChars));
        if (includeUppercase)
            pool.Append(FilterChars(UppercaseChars));
        if (includeNumbers)
            pool.Append(FilterChars(NumberChars));
        if (includeSymbols && !useCustomSymbols)
            pool.Append(FilterChars(defaultSymbols));
        if (useCustomSymbols && !string.IsNullOrEmpty(customSymbols))
            pool.Append(FilterChars(customSymbols));

        return pool.ToString();
    }

    private string FilterChars(string chars)
    {
        var result = chars;
        if (excludeAmbiguous)
            result = new string(result.Where(c => !AmbiguousChars.Contains(c)).ToArray());
        if (excludeSimilar)
            result = new string(result.Where(c => !SimilarChars.Contains(c)).ToArray());
        return result;
    }

    private string GeneratePasswordCandidate(string charPool)
    {
        var password = new char[passwordLength];
        var usedChars = new HashSet<char>();

        for (int i = 0; i < passwordLength; i++)
        {
            char selectedChar;
            int attempts = 0;
            do
            {
                selectedChar = charPool[RandomNumberGenerator.GetInt32(charPool.Length)];
                attempts++;
                if (attempts > 100) break;
            }
            while (noRepeating && usedChars.Contains(selectedChar));

            password[i] = selectedChar;
            if (noRepeating)
                usedChars.Add(selectedChar);
        }

        return new string(password);
    }

    private bool ValidatePassword(string password)
    {
        // Check begin with letter
        if (beginWithLetter && !char.IsLetter(password[0]))
            return false;

        // Check no sequential
        if (noSequential && HasSequentialChars(password))
            return false;

        // Check minimum requirements
        if (requireAll)
        {
            if (includeLowercase && password.Count(char.IsLower) < minLowercase)
                return false;
            if (includeUppercase && password.Count(char.IsUpper) < minUppercase)
                return false;
            if (includeNumbers && password.Count(char.IsDigit) < minNumbers)
                return false;
            
            var symbols = useCustomSymbols ? customSymbols : defaultSymbols;
            if ((includeSymbols || useCustomSymbols) && password.Count(c => symbols.Contains(c)) < minSymbols)
                return false;
        }

        return true;
    }

    private bool HasSequentialChars(string password)
    {
        for (int i = 0; i < password.Length - 2; i++)
        {
            if (password[i + 1] == password[i] + 1 && password[i + 2] == password[i] + 2)
                return true;
            if (password[i + 1] == password[i] - 1 && password[i + 2] == password[i] - 2)
                return true;
        }
        return false;
    }

    private int CalculateStrength(string password)
    {
        int score = 0;
        
        // Length score
        if (password.Length >= 8) score += 1;
        if (password.Length >= 12) score += 1;
        if (password.Length >= 16) score += 1;
        if (password.Length >= 24) score += 1;
        
        // Character variety
        if (password.Any(char.IsLower)) score += 1;
        if (password.Any(char.IsUpper)) score += 1;
        if (password.Any(char.IsDigit)) score += 1;
        if (password.Any(c => !char.IsLetterOrDigit(c))) score += 1;
        
        // Penalty for patterns
        if (HasSequentialChars(password)) score -= 1;
        if (password.Distinct().Count() < password.Length / 2) score -= 1;
        
        return Math.Max(0, Math.Min(5, score));
    }

    private string GetStrengthLabel(string password)
    {
        return CalculateStrength(password) switch
        {
            0 or 1 => "Very Weak",
            2 => "Weak",
            3 => "Fair",
            4 => "Strong",
            _ => "Very Strong"
        };
    }

    private string GetStrengthClass(string password)
    {
        return CalculateStrength(password) switch
        {
            0 or 1 => "very-weak",
            2 => "weak",
            3 => "fair",
            4 => "strong",
            _ => "very-strong"
        };
    }
}
