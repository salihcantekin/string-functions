@page "/json-formatter"

<SeoHead Route="json-formatter" />
@using System.Text.Json

<PageTitle>JSON Formatter</PageTitle>

<ToolPageLayout Title="JSON Formatter" Description="Validate, format, and beautify or minify JSON.">
    <OptionsContent>
        <div class="option-group">
            <span class="option-label">Mode:</span>
            <FluentSelect TOption="string" @bind-Value="@formatMode" Style="min-width: 140px;" @bind-Value:after="ProcessJson">
                <FluentOption Value="prettify">Prettify</FluentOption>
                <FluentOption Value="minify">Minify</FluentOption>
            </FluentSelect>
        </div>
        @if (formatMode == "prettify")
        {
            <div class="option-divider"></div>
            <div class="option-group">
                <span class="option-label">Indent:</span>
                <FluentNumberField @bind-Value="@indentSize" Min="1" Max="8" Style="width: 70px;" @bind-Value:after="ProcessJson" />
            </div>
            <FluentCheckbox @bind-Value="@sortKeys" Label="Sort keys" @bind-Value:after="ProcessJson" />
        }
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@escapeNonAscii" Label="Escape non-ASCII" @bind-Value:after="ProcessJson" />
    </OptionsContent>
    <ChildContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <FluentMessageBar Title="JSON Error" Intent="MessageIntent.Error" Style="margin-bottom: 8px;">
                @errorMessage
            </FluentMessageBar>
        }
        else if (isValid)
        {
            <FluentMessageBar Title="Valid JSON" Intent="MessageIntent.Success" Style="margin-bottom: 8px;">
                @statistics
            </FluentMessageBar>
        }

        <div class="json-tool-grid">
            <JsonInputArea Title="Input JSON"
                          @bind-Value="@inputJson"
                          Placeholder='{"name": "John", "age": 30}'
                          ShowFormatButton="false"
                          ShowCopyButton="false"
                          ValidateOnChange="false" />

            <div class="output-panel">
                <div class="output-header">
                    <span class="output-title">Output JSON</span>
                    <CopyButton Text="@outputJson" />
                </div>
                <FluentTextArea Value="@outputJson" 
                               ReadOnly="true"
                               Resize="TextAreaResize.Vertical" />
            </div>
        </div>
    </ChildContent>
</ToolPageLayout>

<style>
    .json-tool-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        flex: 1;
    }

    .output-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .output-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 32px;
    }

    .output-title {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--text-primary);
    }

    @@media (max-width: 768px) {
        .json-tool-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }
    }
</style>

@code {
    private string inputJson = string.Empty;
    private string outputJson = string.Empty;
    private string errorMessage = string.Empty;
    private string statistics = string.Empty;
    private string formatMode = "prettify";
    private int indentSize = 2;
    private bool sortKeys = false;
    private bool escapeNonAscii = false;
    private bool isValid = false;

    private void ProcessJson()
    {
        errorMessage = string.Empty;
        isValid = false;
        statistics = string.Empty;
        
        if (string.IsNullOrWhiteSpace(inputJson))
        {
            outputJson = string.Empty;
            return;
        }

        try
        {
            using var doc = JsonDocument.Parse(inputJson);
            
            var options = new JsonSerializerOptions
            {
                WriteIndented = formatMode == "prettify",
                Encoder = escapeNonAscii 
                    ? System.Text.Encodings.Web.JavaScriptEncoder.Default 
                    : System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            };

            if (formatMode == "prettify")
            {
                var json = JsonSerializer.Serialize(doc.RootElement, options);
                
                if (indentSize != 2)
                {
                    var lines = json.Split('\n');
                    var result = new System.Text.StringBuilder();
                    foreach (var line in lines)
                    {
                        var leadingSpaces = line.TakeWhile(c => c == ' ').Count();
                        var indentLevel = leadingSpaces / 2;
                        var newIndent = new string(' ', indentLevel * indentSize);
                        result.AppendLine(newIndent + line.TrimStart());
                    }
                    outputJson = result.ToString().TrimEnd();
                }
                else
                {
                    outputJson = json;
                }
                
                if (sortKeys)
                {
                    outputJson = SortJsonKeys(outputJson);
                }
            }
            else
            {
                outputJson = JsonSerializer.Serialize(doc.RootElement, options);
            }

            isValid = true;
            
            var originalSize = System.Text.Encoding.UTF8.GetByteCount(inputJson);
            var formattedSize = System.Text.Encoding.UTF8.GetByteCount(outputJson);
            var sizeDiff = formattedSize - originalSize;
            
            statistics = $"Original: {originalSize} bytes | Result: {formattedSize} bytes | Diff: {sizeDiff:+#;-#;0} bytes";
        }
        catch (JsonException ex)
        {
            errorMessage = $"Line {ex.LineNumber}, Position {ex.BytePositionInLine}: {ex.Message}";
            outputJson = string.Empty;
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            outputJson = string.Empty;
        }
    }

    private string SortJsonKeys(string json)
    {
        try
        {
            using var doc = JsonDocument.Parse(json);
            var sorted = SortJsonElement(doc.RootElement);
            var options = new JsonSerializerOptions
            {
                WriteIndented = true,
                Encoder = escapeNonAscii 
                    ? System.Text.Encodings.Web.JavaScriptEncoder.Default 
                    : System.Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
            };
            return JsonSerializer.Serialize(sorted, options);
        }
        catch
        {
            return json;
        }
    }

    private object? SortJsonElement(JsonElement element)
    {
        switch (element.ValueKind)
        {
            case JsonValueKind.Object:
                var dict = new SortedDictionary<string, object?>();
                foreach (var prop in element.EnumerateObject())
                {
                    dict[prop.Name] = SortJsonElement(prop.Value);
                }
                return dict;
            
            case JsonValueKind.Array:
                return element.EnumerateArray().Select(SortJsonElement).ToList();
            
            case JsonValueKind.String:
                return element.GetString();
            
            case JsonValueKind.Number:
                if (element.TryGetInt64(out var longValue))
                    return longValue;
                return element.GetDouble();
            
            case JsonValueKind.True:
                return true;
            
            case JsonValueKind.False:
                return false;
            
            case JsonValueKind.Null:
                return null;
            
            default:
                return null;
        }
    }
}
