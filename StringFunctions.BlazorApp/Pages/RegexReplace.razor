@page "/regex-replace"

<SeoHead Route="regex-replace" />
@using System.Text.RegularExpressions

<PageTitle>Regex Replace</PageTitle>

<ToolPageLayout Title="Regex Replace" Description="Find and replace text using regular expressions with group support.">
    <OptionsContent>
        <div class="option-group">
            <span class="option-label">Pattern:</span>
            <FluentTextField @bind-Value="@pattern" Placeholder="(\d+)" Style="min-width: 150px;" 
                             @bind-Value:after="ProcessReplace" />
        </div>
        <div class="option-group">
            <span class="option-label">Replace:</span>
            <FluentTextField @bind-Value="@replacement" Placeholder="Number: $1" Style="min-width: 150px;" 
                             @bind-Value:after="ProcessReplace" />
        </div>
        <div class="option-divider"></div>
        <FluentCheckbox @bind-Value="@ignoreCase" Label="Ignore case" @bind-Value:after="ProcessReplace" />
        <FluentCheckbox @bind-Value="@multiline" Label="Multiline" @bind-Value:after="ProcessReplace" />
        <div class="option-divider"></div>
        <div class="option-group">
            <span class="option-label">Max:</span>
            <FluentNumberField @bind-Value="@maxReplacements" Min="0" Style="width: 70px;" 
                               @bind-Value:after="ProcessReplace" />
        </div>
    </OptionsContent>
    <ChildContent>
        @if (!string.IsNullOrEmpty(regexError))
        {
            <FluentMessageBar Title="Regex Error" Intent="MessageIntent.Error" Style="margin-bottom: 8px;">
                @regexError
            </FluentMessageBar>
        }
        
        <FluentMessageBar Intent="MessageIntent.Info" Style="margin-bottom: 8px;">
            Use $1, $2... to reference capture groups. $& represents the entire match. Set max to 0 to replace all.
        </FluentMessageBar>

        <div class="io-grid">
            <div class="io-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">Input</span>
                </div>
                <FluentTextArea @bind-Value="@inputText" 
                               Placeholder="Enter text..."
                               Resize="TextAreaResize.Vertical"
                               @oninput="OnInputChanged" />
            </div>

            <div class="io-panel">
                <div class="io-panel-header">
                    <span class="io-panel-title">Output @(replacementCount > 0 ? $"({replacementCount} replacements)" : "")</span>
                    <CopyButton Text="@outputText" />
                </div>
                <FluentTextArea Value="@outputText" 
                               ReadOnly="true"
                               Resize="TextAreaResize.Vertical" />
            </div>
        </div>
    </ChildContent>
</ToolPageLayout>

<style>
    .io-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        flex: 1;
    }

    .io-panel {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .io-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 32px;
    }

    .io-panel-title {
        font-weight: 600;
        color: var(--text-primary);
    }

    @@media (max-width: 768px) {
        .io-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

@code {
    private string inputText = string.Empty;
    private string outputText = string.Empty;
    private string pattern = @"(\d+)";
    private string replacement = "Number: $1";
    private string regexError = string.Empty;
    private bool ignoreCase = false;
    private bool multiline = false;
    private int maxReplacements = 0;
    private int replacementCount = 0;

    private void OnInputChanged(ChangeEventArgs e)
    {
        inputText = e.Value?.ToString() ?? string.Empty;
        ProcessReplace();
    }

    private void ProcessReplace()
    {
        regexError = string.Empty;
        replacementCount = 0;
        
        if (string.IsNullOrEmpty(inputText))
        {
            outputText = string.Empty;
            return;
        }

        if (string.IsNullOrEmpty(pattern))
        {
            outputText = inputText;
            return;
        }

        try
        {
            var options = RegexOptions.None;
            if (ignoreCase) options |= RegexOptions.IgnoreCase;
            if (multiline) options |= RegexOptions.Multiline;

            var regex = new Regex(pattern, options);
            
            if (maxReplacements > 0)
            {
                var count = 0;
                outputText = regex.Replace(inputText, m =>
                {
                    if (count < maxReplacements)
                    {
                        count++;
                        replacementCount++;
                        return regex.Replace(m.Value, replacement);
                    }
                    return m.Value;
                });
            }
            else
            {
                var matches = regex.Matches(inputText);
                replacementCount = matches.Count;
                outputText = regex.Replace(inputText, replacement);
            }
        }
        catch (Exception ex)
        {
            regexError = ex.Message;
            outputText = inputText;
        }
    }
}
